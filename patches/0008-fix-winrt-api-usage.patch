From 8a31acc16501cc433757a766e3a069820c8384bc Mon Sep 17 00:00:00 2001
From: Tung Huynh <tung75605@gmail.com>
Date: Thu, 14 Dec 2023 21:57:06 -0800
Subject: [PATCH 8/8] fix winrt api usage

---
 src/win32/dirs.c | 34 +++++++++++++++++++++-------------
 1 file changed, 21 insertions(+), 13 deletions(-)

diff --git a/src/win32/dirs.c b/src/win32/dirs.c
index 8a8876a1a2..081925226f 100644
--- a/src/win32/dirs.c
+++ b/src/win32/dirs.c
@@ -51,6 +51,14 @@
 #include <winstring.h>
 #include <windows.storage.h>
 #include <roapi.h>
+typedef __x_ABI_CWindows_CStorage_CIStorageFolder IStorageFolder;
+typedef __x_ABI_CWindows_CStorage_CIApplicationDataStatics IApplicationDataStatics;
+typedef __x_ABI_CWindows_CStorage_CIApplicationData IApplicationData;
+typedef __x_ABI_CWindows_CStorage_CIStorageItem IStorageItem;
+typedef __x_ABI_CWindows_CStorage_CIKnownFoldersStatics IKnownFoldersStatics;
+#define IID_IApplicationDataStatics IID___x_ABI_CWindows_CStorage_CIApplicationDataStatics
+#define IID_IKnownFoldersStatics IID___x_ABI_CWindows_CStorage_CIKnownFoldersStatics
+#define IID_IStorageItem IID___x_ABI_CWindows_CStorage_CIStorageItem
 
 #ifndef CSIDL_LOCAL_APPDATA
 # define CSIDL_LOCAL_APPDATA 0x001C
@@ -92,7 +100,7 @@ static HRESULT WinRTSHGetFolderPath(HWND hwnd, int csidl, HANDLE hToken, DWORD d
             goto end_appdata;
         }
 
-        hr = IApplicationDataStatics_get_Current(appDataStatics, &appData);
+        hr = appDataStatics->lpVtbl->get_Current(appDataStatics, &appData);
 
         if (FAILED(hr))
             goto end_appdata;
@@ -102,14 +110,14 @@ static HRESULT WinRTSHGetFolderPath(HWND hwnd, int csidl, HANDLE hToken, DWORD d
             goto end_appdata;
         }
 
-        hr = IApplicationData_get_LocalFolder(appData, &folder);
+        hr = appData->lpVtbl->get_LocalFolder(appData, &folder);
 
 end_appdata:
         WindowsDeleteString(hClassName);
         if (appDataStatics)
-            IApplicationDataStatics_Release(appDataStatics);
+            appDataStatics->lpVtbl->Release(appDataStatics);
         if (appData)
-            IApplicationData_Release(appData);
+            appData->lpVtbl->Release(appData);
     }
     else
     {
@@ -135,16 +143,16 @@ end_appdata:
 
         switch (csidl) {
         case CSIDL_PERSONAL:
-            hr = IKnownFoldersStatics_get_DocumentsLibrary(knownFoldersStatics, &folder);
+            hr = knownFoldersStatics->lpVtbl->get_DocumentsLibrary(knownFoldersStatics, &folder);
             break;
         case CSIDL_MYMUSIC:
-            hr = IKnownFoldersStatics_get_MusicLibrary(knownFoldersStatics, &folder);
+            hr = knownFoldersStatics->lpVtbl->get_MusicLibrary(knownFoldersStatics, &folder);
             break;
         case CSIDL_MYPICTURES:
-            hr = IKnownFoldersStatics_get_PicturesLibrary(knownFoldersStatics, &folder);
+            hr = knownFoldersStatics->lpVtbl->get_PicturesLibrary(knownFoldersStatics, &folder);
             break;
         case CSIDL_MYVIDEO:
-            hr = IKnownFoldersStatics_get_VideosLibrary(knownFoldersStatics, &folder);
+            hr = knownFoldersStatics->lpVtbl->get_VideosLibrary(knownFoldersStatics, &folder);
             break;
         default:
             hr = E_NOTIMPL;
@@ -153,7 +161,7 @@ end_appdata:
 end_other:
         WindowsDeleteString(hClassName);
         if (knownFoldersStatics)
-            IKnownFoldersStatics_Release(knownFoldersStatics);
+            knownFoldersStatics->lpVtbl->Release(knownFoldersStatics);
     }
 
     if( SUCCEEDED(hr) && folder != NULL )
@@ -161,19 +169,19 @@ end_other:
         HSTRING path = NULL;
         IStorageItem *item = NULL;
         PCWSTR pszPathTemp;
-        hr = IStorageFolder_QueryInterface(folder, &IID_IStorageItem, (void**)&item);
+        hr = folder->lpVtbl->QueryInterface(folder, &IID_IStorageItem, (void**)&item);
         if (FAILED(hr))
             goto end_folder;
-        hr = IStorageItem_get_Path(item, &path);
+        hr = item->lpVtbl->get_Path(item, &path);
         if (FAILED(hr))
             goto end_folder;
         pszPathTemp = WindowsGetStringRawBuffer(path, NULL);
         wcscpy(pszPath, pszPathTemp);
 end_folder:
         WindowsDeleteString(path);
-        IStorageFolder_Release(folder);
+        folder->lpVtbl->Release(folder);
         if (item)
-            IStorageItem_Release(item);
+            item->lpVtbl->Release(item);
     }
 
     return hr;
-- 
2.42.0.windows.2

